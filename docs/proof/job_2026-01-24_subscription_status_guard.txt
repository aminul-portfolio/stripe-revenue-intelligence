=== Subscription status guard (reject 'cancelled') — 2026-01-24 ===

## Migration created
0004_alter_subscription_status_and_more.py

## Targeted test (analytics subscription metrics)
Found 1 test(s). Operations to perform:   Synchronize unmigrated apps: messages, staticfiles   Apply all migrations: accounts, admin, analyticsapp, audit, auth, contenttypes, monitoring, orders, payments, products, sessions, subscriptions, wishlist Synchronizing apps without migrations:   Creating tables...     Running deferred SQL... Running migrations:   Applying contenttypes.0001_initial... OK   Applying auth.0001_initial... OK   Applying accounts.0001_initial... OK   Applying accounts.0002_alter_userrole_role... OK   Applying accounts.0003_add_customer_role_backfill... OK   Applying admin.0001_initial... OK   Applying admin.0002_logentry_remove_auto_add... OK   Applying admin.0003_logentry_add_action_flag_choices... OK   Applying products.0001_initial... OK   Applying analyticsapp.0001_initial... OK   Applying analyticsapp.0002_analyticsproductdaily... OK   Applying audit.0001_initial... OK   Applying contenttypes.0002_remove_content_type_name... OK   Applying auth.0002_alter_permission_name_max_length... OK   Applying auth.0003_alter_user_email_max_length... OK   Applying auth.0004_alter_user_username_opts... OK   Applying auth.0005_alter_user_last_login_null... OK   Applying auth.0006_require_contenttypes_0002... OK   Applying auth.0007_alter_validators_add_error_messages... OK   Applying auth.0008_alter_user_username_max_length... OK   Applying auth.0009_alter_user_last_name_max_length... OK   Applying auth.0010_alter_group_name_max_length... OK   Applying auth.0011_update_proxy_permissions... OK   Applying auth.0012_alter_user_first_name_max_length... OK   Applying monitoring.0001_initial... OK   Applying monitoring.0002_alter_dataqualityissue_options_and_more... OK   Applying monitoring.0003_normalize_issue_types... OK   Applying monitoring.0004_alter_dataqualityissue_issue_type... OK   Applying orders.0001_initial... OK   Applying orders.0002_orderitem_product_orderitem_variant... OK   Applying orders.0003_alter_order_options_order_refund_amount_pennies_and_more... OK   Applying orders.0004_normalize_canceled_spelling... OK   Applying orders.0005_alter_order_status... OK   Applying payments.0001_initial... OK   Applying payments.0002_stripeevent_payments_st_event_t_af3af6_idx_and_more... OK   Applying sessions.0001_initial... OK   Applying subscriptions.0001_initial... OK   Applying subscriptions.0002_rename_cancelled_at_subscription_canceled_at_and_more... OK   Applying subscriptions.0003_stripecustomer... OK   Applying subscriptions.0004_alter_subscription_status_and_more... OK   Applying wishlist.0001_initial... OK System check identified no issues (0 silenced).

## Full suite
Found 64 test(s). System check identified no issues (0 silenced).

## Gates
System check identified no issues (0 silenced).
Snapshots built for 90 day(s). created=0, updated=90, product_rows_upserted=16 Issues: 0 (open=0, resolved=3)  Breakdown:  - analytics_snapshot_reconciliation / resolved: 1  - invalid_order_state / resolved: 1  - payment_mismatch / resolved: 1  Latest 10 open issues:  - (none open)
No changes detected

## Constraint presence (migration list)
subscriptions  [X] 0001_initial  [X] 0002_rename_cancelled_at_subscription_canceled_at_and_more  [X] 0003_stripecustomer  [X] 0004_alter_subscription_status_and_more

## Diff
diff --git a/subscriptions/models.py b/subscriptions/models.py index 6148409..2d0c125 100644 --- a/subscriptions/models.py +++ b/subscriptions/models.py @@ -1,10 +1,24 @@  from __future__ import annotations    from decimal import Decimal +  from django.conf import settings  from django.db import models  from django.utils import timezone   +# Canonical subscription status values (American spelling: "canceled") +# Keeping this explicit ensures the DB-level constraint is stable and predictable. +SUBSCRIPTION_STATUS_VALUES = ( +    "incomplete", +    "incomplete_expired", +    "trialing", +    "active", +    "past_due", +    "canceled", +    "unpaid", +    "paused", +) +    class Subscription(models.Model):      class Status(models.TextChoices): @@ -25,7 +39,10 @@ class Subscription(models.Model):      stripe_price_id = models.CharField(max_length=255, blank=True, db_index=True)        status = models.CharField( -        max_length=30, choices=Status.choices, default=Status.INCOMPLETE +        max_length=30, +        choices=Status.choices, +        default=Status.INCOMPLETE, +        db_index=True,      )        current_period_start = models.DateTimeField(null=True, blank=True) @@ -35,6 +52,7 @@ class Subscription(models.Model):      canceled_at = models.DateTimeField(null=True, blank=True)      ended_at = models.DateTimeField(null=True, blank=True)   +    # Stored as integer pennies (GBP)      mrr_pennies = models.IntegerField(default=0)        created_at = models.DateTimeField(auto_now_add=True) @@ -46,12 +64,17 @@ class Subscription(models.Model):              models.Index(fields=["stripe_subscription_id"]),              models.Index(fields=["stripe_customer_id"]),          ] +        constraints = [ +            # DB-level guard: prevents invalid status strings (e.g., "cancelled") from persisting. +            models.CheckConstraint( +                name="subscription_status_valid", +                check=models.Q(status__in=SUBSCRIPTION_STATUS_VALUES), +            ), +        ]        @property      def mrr_gbp(self) -> Decimal: -        return (Decimal(self.mrr_pennies or 0) / Decimal("100")).quantize( -            Decimal("0.01") -        ) +        return (Decimal(self.mrr_pennies or 0) / Decimal("100")).quantize(Decimal("0.01"))        def mark_canceled_local(self) -> None:          if not self.canceled_at:
